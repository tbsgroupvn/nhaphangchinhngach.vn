<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TBS GROUP - Qu·∫£n tr·ªã n·ªôi dung</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }
    
    .logo {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .subtitle {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      opacity: 0.9;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .cms-container {
      display: none;
    }
    
    .cms-container.loaded {
      display: block;
    }
    
    .auth-message {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      color: white;
      text-align: center;
      padding: 20px;
    }
    
    .auth-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 40px;
      max-width: 600px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .auth-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      text-decoration: none;
      display: inline-block;
    }
    
    .auth-button:hover {
      background: white;
      color: #667eea;
      transform: translateY(-2px);
    }
    
    .auth-button.primary {
      background: rgba(34, 197, 94, 0.3);
      border-color: #22c55e;
    }
    
    .auth-button.primary:hover {
      background: #22c55e;
      color: white;
    }
    
    .setup-steps {
      background: rgba(255, 193, 7, 0.1);
      border: 2px solid rgba(255, 193, 7, 0.3);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: left;
    }
    
    .setup-steps h4 {
      color: #ffeb3b;
      margin-bottom: 15px;
    }
    
    .setup-steps ol {
      margin-left: 20px;
    }
    
    .setup-steps li {
      margin: 8px 0;
      line-height: 1.4;
    }
    
    /* Custom CSS cho Netlify CMS */
    .nc-app-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    
    .nc-app-header h1 {
      color: white !important;
    }
    
    .nc-entryEditor-editor {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    }
    
    /* Identity widget custom styling */
    .netlify-identity-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="logo">TBS GROUP</div>
    <div class="subtitle">ƒêang t·∫£i h·ªá th·ªëng qu·∫£n tr·ªã...</div>
    <div class="spinner"></div>
  </div>
  
  <div class="auth-message" id="authMessage" style="display: none;">
    <div class="auth-card">
      <div class="logo">üîê TBS GROUP CMS</div>
      <h3 style="margin-bottom: 20px;">Setup Authentication Required</h3>
      <p style="margin-bottom: 20px; opacity: 0.9;">
        CMS s·ª≠ d·ª•ng Auth0 by Okta extension cho authentication.<br/>
        Vui l√≤ng ho√†n th√†nh setup ƒë·ªÉ truy c·∫≠p CMS.
      </p>
      
      <div class="setup-steps">
        <h4>üìã Setup Auth0 Extension:</h4>
        <ol>
          <li>V√†o <strong>Netlify Dashboard</strong> ‚Üí Site c·ªßa b·∫°n</li>
          <li><strong>Integrations</strong> ‚Üí <strong>Browse</strong> ‚Üí T√¨m <strong>"Auth0 by Okta"</strong></li>
          <li>Click <strong>Install</strong> extension</li>
          <li><strong>Site configuration</strong> ‚Üí <strong>Extensions</strong> ‚Üí <strong>Auth0 by Okta</strong></li>
          <li><strong>Add a tenant</strong> ‚Üí Login Auth0 account</li>
          <li><strong>Select project</strong> ‚Üí <strong>Save</strong></li>
          <li><strong>Site Settings</strong> ‚Üí <strong>Identity</strong> ‚Üí <strong>Enable Identity</strong></li>
          <li><strong>Registration</strong> ‚Üí <strong>"Invite only"</strong></li>
          <li><strong>Services</strong> ‚Üí Enable <strong>"Git Gateway"</strong></li>
          <li><strong>Identity tab</strong> ‚Üí <strong>"Invite users"</strong> ‚Üí Nh·∫≠p email</li>
        </ol>
      </div>
      
      <button class="auth-button primary" onclick="openLogin()">
        üöÄ Th·ª≠ ƒëƒÉng nh·∫≠p CMS
      </button>
      <a href="/admin/debug.html" class="auth-button">
        üîß Trang Debug
      </a>
      <a href="https://app.netlify.com" target="_blank" class="auth-button">
        ‚öôÔ∏è Netlify Dashboard
      </a>
      
      <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
        <p>C·∫ßn h·ªó tr·ª£? Ki·ªÉm tra <strong>Debug page</strong> ƒë·ªÉ x√°c ƒë·ªãnh v·∫•n ƒë·ªÅ.</p>
      </div>
    </div>
  </div>
  
  <div class="cms-container" id="cmsContainer">
    <!-- Netlify CMS s·∫Ω render ·ªü ƒë√¢y -->
  </div>
  
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  
  <script>
    // C·∫•u h√¨nh ng√¥n ng·ªØ ti·∫øng Vi·ªát
    CMS.registerLocale('vi', {
      app: {
        header: {
          content: 'N·ªôi dung',
          workflow: 'Quy tr√¨nh',
          media: 'Th∆∞ vi·ªán',
          quickAdd: 'Th√™m nhanh'
        }
      },
      collection: {
        sidebar: {
          collections: 'B·ªô s∆∞u t·∫≠p',
          searchAll: 'T√¨m ki·∫øm t·∫•t c·∫£'
        }
      },
      editor: {
        editorControl: {
          field: {
            optional: 't√πy ch·ªçn'
          }
        },
        editorControlPane: {
          widget: {
            headingOneTitle: 'Ti√™u ƒë·ªÅ 1',
            headingTwoTitle: 'Ti√™u ƒë·ªÅ 2',
            headingThreeTitle: 'Ti√™u ƒë·ªÅ 3',
            headingFourTitle: 'Ti√™u ƒë·ªÅ 4',
            headingFiveTitle: 'Ti√™u ƒë·ªÅ 5',
            headingSixTitle: 'Ti√™u ƒë·ªÅ 6',
            bold: 'ƒê·∫≠m',
            italic: 'Nghi√™ng',
            code: 'M√£',
            link: 'Li√™n k·∫øt',
            linkPrompt: 'Nh·∫≠p URL li√™n k·∫øt',
            linkTooltip: 'Th√™m li√™n k·∫øt',
            bullist: 'Danh s√°ch c√≥ d·∫•u ƒë·∫ßu d√≤ng',
            numlist: 'Danh s√°ch c√≥ s·ªë',
            addComponent: 'Th√™m th√†nh ph·∫ßn',
            richText: 'VƒÉn b·∫£n phong ph√∫',
            markdown: 'Markdown'
          }
        }
      }
    });
    
    function openLogin() {
      if (window.netlifyIdentity) {
        try {
          window.netlifyIdentity.open();
          console.log('‚úÖ Opened identity widget');
        } catch (error) {
          console.error('‚ùå Error opening identity:', error);
          alert('L·ªói m·ªü identity widget. Vui l√≤ng ki·ªÉm tra setup Auth0 extension.');
        }
      } else {
        console.error('‚ùå Netlify Identity not available');
        alert('Netlify Identity ch∆∞a s·∫µn s√†ng. Vui l√≤ng ho√†n th√†nh setup Auth0 extension.');
      }
    }
    
    function hideLoading() {
      document.getElementById('loadingScreen').style.display = 'none';
    }
    
    function showAuthMessage() {
      hideLoading();
      document.getElementById('authMessage').style.display = 'flex';
    }
    
    function hideAuthMessage() {
      document.getElementById('authMessage').style.display = 'none';
      document.getElementById('cmsContainer').classList.add('loaded');
    }
    
    function initializeCMS() {
      try {
        // Kh·ªüi t·∫°o CMS v·ªõi c·∫•u h√¨nh Auth0 extension
        CMS.init({
          config: {
            load_config_file: true,
            // Local backend ch·ªâ enable khi localhost
            local_backend: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',
            // Auth0 extension s·∫Ω t·ª± ƒë·ªông inject environment variables
          }
        });
        
        console.log('‚úÖ CMS initialized successfully');
        hideAuthMessage();
      } catch (error) {
        console.error('‚ùå Error initializing CMS:', error);
        showAuthMessage();
      }
    }
    
    // Enhanced error handling function
    function handleAuthError(error, context) {
      console.error(`‚ùå Auth error in ${context}:`, error);
      
      let errorMessage = 'Authentication error occurred. ';
      
      if (error.message && error.message.includes('auth0')) {
        errorMessage += 'Please check Auth0 extension configuration.';
      } else if (error.message && error.message.includes('identity')) {
        errorMessage += 'Please enable Netlify Identity service.';
      } else {
        errorMessage += 'Please check debug page for details.';
      }
      
      // Show user-friendly error
      const authCard = document.querySelector('.auth-card h3');
      if (authCard) {
        authCard.textContent = '‚ùå Authentication Error';
        authCard.style.color = '#fecaca';
      }
    }
    
    // Initialize authentication flow
    function initializeAuth() {
      if (!window.netlifyIdentity) {
        console.error('‚ùå Netlify Identity widget not loaded');
        hideLoading();
        showAuthMessage();
        return;
      }
      
      console.log('üîß Netlify Identity widget loaded');
      
      // Check initial auth state
      try {
        const user = window.netlifyIdentity.currentUser();
        
        if (user) {
          console.log('‚úÖ User already authenticated:', user.email);
          initializeCMS();
        } else {
          console.log('‚ö†Ô∏è No authenticated user found');
          hideLoading();
          showAuthMessage();
        }
      } catch (error) {
        handleAuthError(error, 'initial check');
        hideLoading();
        showAuthMessage();
      }
    }
    
    // Netlify Identity event handlers with Auth0 extension support
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        console.log('üîß Identity init event:', user ? user.email : 'no user');
        
        hideLoading();
        
        if (user) {
          console.log('‚úÖ User authenticated on init:', user.email);
          initializeCMS();
        } else {
          console.log('‚ùå User not authenticated on init');
          showAuthMessage();
        }
      });
      
      window.netlifyIdentity.on("login", (user) => {
        console.log('‚úÖ Login successful:', user.email);
        try {
          initializeCMS();
        } catch (error) {
          handleAuthError(error, 'login');
        }
      });
      
      window.netlifyIdentity.on("logout", () => {
        console.log('‚ÑπÔ∏è User logged out');
        showAuthMessage();
      });
      
      window.netlifyIdentity.on("error", (err) => {
        handleAuthError(err, 'identity widget');
        hideLoading();
        showAuthMessage();
      });
      
    } else {
      // Fallback n·∫øu Identity widget kh√¥ng load
      console.error('‚ùå Netlify Identity widget not available');
      setTimeout(() => {
        if (!window.netlifyIdentity) {
          console.error('‚ùå Netlify Identity failed to load after timeout');
          hideLoading();
          showAuthMessage();
        } else {
          initializeAuth();
        }
      }, 5000);
    }
    
    // Debug information
    console.log('üéØ TBS GROUP CMS with Auth0 Extension Support');
    console.log('üåê Environment:', window.location.hostname);
    console.log('üîß Local backend:', window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
    
    // Check if Auth0 extension variables are available
    setTimeout(() => {
      console.log('üîç Checking Auth0 extension environment...');
      // Auth0 extension variables should be available via build process
      console.log('‚ÑπÔ∏è Auth0 variables are managed by Netlify extension');
    }, 1000);
  </script>
</body>
</html> 